---
layout: post
title: "Matrix"
permalink: /:title/
date: 2023-03-17 23:13:07 -0400
categories:
tags:
pin: false
published: false
---

在 DietPi 上部署新版 Matrix 服务器端实现[dendrite](https://github.com/matrix-org/dendrite)

1. 安装 golang

   1. 访问[官方下载页面](https://go.dev/dl/)，下载最新版 golang。注意**根据硬件选对 Arch**，RockPro 是 ARM V8 指令集
   2. 按照[官网步骤](https://go.dev/doc/install)安装 golang

   ```shell
   rm -rf /usr/local/go && tar -C /usr/local -xzf go*.tar.gz
   # bash
   echo 'export PATH=$PATH:/usr/local/go/bin' >> $HOME/.profile
   # zsh
   echo 'export PATH=$PATH:/usr/local/go/bin' >> $HOME/.zshrc
   ```

   3. 退出命令行，重新登录，检查 golang 安装

   ```shell
   go version
   # 输出应该类似
   # go version go1.20.2 linux/arm64
   ```

2. 安装和配置 PostgreSQL

   1. 安装

      dietpi-software 有 PostgreSQL，其他 linux 跟[官网步骤](https://www.postgresql.org/download/)

   2. 添加用户和数据库

      注

      - postgre 每个用户的默认表格名和用户名是一样的，添加用户之后还需要添加表格才能登录。
      - postgre 的登录密码校验有两种模式，peer 是用 linux 这个用户的密码，md5 是用创建 postgre 用户时的密码。
      - 如果之前进行过安装但是忘了密码可以先设置 postgre 允许本地 postgres 用户登录，登录后修改密码，再还原修密码校验方式。

        ```shell
        cd /etc/postgresql/*/main
        vi pg_hba.conf
        # 找到postgres用户一行
        # local    all    postgres    peer
        # 如果最后一个是md5改成peer

        sudo -u postgres psql # 进入postgres命令行
        ```

      列出当前用户

      ```shell
      \du
      ```

      添加用户

      ```shell
      # 命令格式
      CREATE USER [用户名] WITH PASSWORD '[密码]' CREATEDB;
      # eg
      CREATE USER dendrite WITH PASSWORD '1234' CREATEDB; # 密码尽量复杂，不带单双引号比较方便
      ```

      弄错了删除用户

      ```shell
      DROP USER dendrite;
      ```

3. 下载，编译 dendrite

```shell
git clone https://github.com/matrix-org/dendrite
cd dendrite
./build.sh
```

4. 运行
   1.
   ```shell
   ./bin/generate-keys --private-key matrix_key.pem
   cp dendrite-sample.yaml dendrite.yaml
   ```
   2. 进行简单配置
5. 用户管理
6. 作为服务运行
