---
title: "DietPi搭建个人服务器"
author: "Lin Han"
date: "2021-02-27 15:57 +8"
categories:
  - SelfHost
tags:
  - SelfHost
published: false
---

## 软硬件

硬件：出了板子和网线都选配

- [Rock Pro 64](https://www.pine64.org/rockpro64/)：内存比较大
- 网线
- [散热风扇](https://pine64.com/product/rockpro64-10mm-low-profile-heatsink-with-fan/)
- [被动散热](https://pine64.com/product/rockpro64-30mm-tall-profile-heatsink/)
- [emmc 存储](https://pine64.com/product/64gb-emmc-module/)：SD 卡和 emmc 模块都存在时，RockPro 默认从 emmc 模块启动，需要配 usb 到 emmc 的转接口才能直接从电脑上往 emmc 模块刷系统
- [壳](https://pine64.com/product/rockpro64-premium-aluminum-casing/)：金属材质，带散热柱，平时待机肯定压得住，不过烤机或者装软件过程中温度能上到小 50，这个角度赶不上主动散热。
- 机械硬盘

软件

- [DietPi 系统](https://dietpi.com/#downloadinfo)：下 ROCKPro64 镜像
- [etcher](https://www.balena.io/etcher)

## 启动

装 Etcher，从 dietpi 官网根据板子型号下镜像，解压拿到里面的 img 文件，把镜像刷上 sd 卡或者 emmc 模块。dietpi 是有开机键的，插电之后按左侧按钮 1s，开机键旁边有一个白色的按钮开始闪是控制已经交给操作系统。注意 sd 卡和 emmc 模块都存在时默认从 emmc 启动，如果 emmc 没有系统要插上 emmc 插槽旁边的跳线在启动时禁用 emmc。

### 从 sd 卡启动

SD 卡上刷系统，上电，开机键按 1s，看到白灯闪。从路由器找板子 ip，默认用户 root，密码 dietpi。首次开机后自动进行一些升级，之后会重启。重新登录后设置软件初始密码，root 密码，禁用 uart，之后出 dietpi-software 界面，可以把 dorpbear 换成 openssh。

### 从 emmc 启动

如果能从电脑把系统刷进 emmc，和 sd 卡启动过程完全一样。

如果想用 emmc 启动但是没有转接口，可以先做一个系统从 sd 卡启动，之后在 RockPro 上往 emmc 里刷系统。插上 emmc 模块旁边的跳线（启动时先断开 emmc 模块），断电，插电，开机键 1s，等 2s，拔掉跳线（重新连通 emmc 模块）。拔早了会从空的 emmc 启动，拔晚了进系统之后也看不到 emmc。

刷系统步骤参考了[这篇](https://wiki.radxa.com/Rockpi4/install/eMMC)

```shell
lsblk # 查看所有硬盘
df -h . # 查看当前所在目录所在分区剩余空间，这个命令的输出开头有当前所在的分区，区分哪个存储设备是sd卡哪个是emmc
# 启动镜像可以再dietpi上下，或者电脑上下完scp到板子上
dd if=DietPi_ROCKPro64-ARMv8-Bullseye.img of=/dev/mmcblk2 bs=1M # 写系统到emmc，注意of就写到盘，不写分区
```

之后重新启动时弹出 sd 卡，就会从 emmc 启动。

## 安全

各种密码尽量设的复杂，往公网暴露 ssh 很容易招来爆破。

查看 ssh 暴破

```shell
journalctl -xe | grep "Failed password"
```

注意 dietpi 默认只保存 1h 的 log，如果没改过这个设置上述命令只能查看过去 1h。

### openssh

配置身份文件登陆。在本地：

```shell
ssh-keygen
ssh-copy-id -i [/path/to/keyfile] [user@server.address]

# ~/.ssh/config
Host server
  HostName [server.address]
  User [username]
  IdentityFile [/path/to/private/key/file]
```

[参考](https://www.hostinger.com/tutorials/how-to-setup-passwordless-ssh/)

把 root 密码改的复杂一点，或者禁用密码登陆

```shell
vi /etc/ssh/sshd_config
# 修改这行
PasswordAuthentication no

systemctl restart ssh
```

[ref](https://linuxhandbook.com/ssh-disable-password-authentication/)

修改 ssh 端口。没啥大用，攻方感兴趣可以 nmap 扫一下 host 开放的所有端口，一定找得到新的端口。

```shell

```

### dropbear

配置身份文件登录：参考 openssh，本地创建一个 keyfile，之后将 .pub 文件的内容贴到服务器上的 ~/.ssh/authorized_keys。

[参考](https://github.com/mkj/dropbear#server-public-key-auth) [dropbear man](https://man.archlinux.org/man/community/dropbear/dropbear.8.en)

<!-- TODO: 怎么禁用密码登录 -->
<!-- TODO: 怎么用scp -->

## 散热

## 安装软件

dietpi 基于 ubuntu，可以用 apt 装东西。不过如果[dietpi-sofware](https://dietpi.com/docs/software/)里提供需要的软件推荐从这个渠道装。配置简单，安装卸载方便。

## ddns

需要有一个域名，可以从[freenom](https://www.freenom.com/en/index.html?lang=en)免费申请，注意买域名后要能改 dns 服务器 ip，我记得 cloudflare 不能改。之后需要一个 ddns 服务商，[dynu](https://www.dynu.com/)有免费的服务，dietpi 也支持。

dietpi 支持的所有 ddns 服务商。

![image](https://user-images.githubusercontent.com/29757093/224500872-22502e87-b835-4bc3-9656-85a22d61723b.png)

之后打 dietpi-ddns，在 tui 中设置

<!-- TODO：记录细节 -->

## https

在申请证书之前最好装好 webserver，这样 dietpi-letsencrypt 会在申请完证书后自动改 webserver 配置让 https 证书生效。

dietpi-letsencrypt 可以申请免费 https 证书，按照 tui 步骤操作就行，会有 cron job 过期更新。

## 服务器健康

- log2ram
- 机械硬盘 mount 和设置

## 软件

可以在 dietpi 上部署一些服务替代日常使用。安装大都不麻烦，安装后配置复杂的单开一篇。

### 网盘

[dietpi 部署 nextcloud]()

### Git

gitea

- https://dietpi.com/docs/software/cloud/#gitea
- https://docs.gitea.io/en-us/

### 密码

### 邮箱

- https://github.com/docker-mailserver/docker-mailserver

### 博客
