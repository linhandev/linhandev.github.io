---
title: "DietPi部署邮件服务"
author: "Lin Han"
date: "2023-03-11 15:57 +8"
categories:
  - SelfHost
  - Mail
tags:
  - SelfHost
  - Mail
published: false
---

[docker mailserver](https://github.com/docker-mailserver/docker-mailserver)（下文简称 DMS），是一个部署起来非常简单的方案。使用 docker 不和其他服务冲突，只包含邮件服务器非常简洁，最小安装需要的内存小于 500M，项目开发活跃。

## 背景知识

邮件服务主要参与者

- MUA：客户端，如 K9 Mail
- MTA：处理发送和接收，如 Postfix
  - 外向邮件给到 MTA，之后 MTA 一跳一跳给到最终收件人的 MTA
  - 内向邮件由 MTA 接收，之后给到 MDA
- MDA：暂存邮件，提供给客户端，如 Dovecot

```shell
Sending an email:    MUA ----> MTA ----> (MTA relays) ----> MDA
Fetching an email:   MUA <--------------------------------- MDA
```

收发邮件涉及的端口和协议

![](assets/img/post/2022-08-17-Mail/2022-11-19-07-00-15-image.png)

[上述参考](https://docker-mailserver.github.io/docker-mailserver/edge/introduction/)

## 前置准备

- 一个域名：可以用 freenom 申请，在家部署可以结合 dynu 的 ddns。**下文这个域名都用 example.com 代表，复制命令时注意替换**
- 设备：少量邮箱，不开杀毒和垃圾邮件过滤的话 DMS 很不吃内存，大概几百 M。硬盘看邮件数量。开 vps 注意下述端口问题
- 端口：25，465，993。如果用了 NAT 这几个端口要穿出去；如果用 vps 要提前查好，很多 vps 墙掉了往外发邮件的 25 端口，一些可以发工单申请开，实在开不了 25 端口可以用发送代理服务，下文有步骤
- 需要 https 证书的域名：imap.example.com，smtp.example.com，推荐 letsencrypt 配置
- 时间：dns 记录如果设错了，修改之后生效会需要一定时间，测试阶段可以把 TTL 设到最小。其他的操作都很简单

## 安装

过完这一部分应该可以正常收邮件和发站内邮件。

下载需要的文件

```shell
DMS_GITHUB_URL='https://raw.githubusercontent.com/docker-mailserver/docker-mailserver/master'
wget "${DMS_GITHUB_URL}/docker-compose.yml"
wget "${DMS_GITHUB_URL}/mailserver.env"
```

测试 docker，下面命令不是报错输出就行

```shell
docker run --rm docker.io/mailserver/docker-mailserver:latest setup help
```

修改配置文件内容

- docker-compose.yml
  - hostname：一般叫 mail
  - domainname：服务器网址，如 example.com
  - volumes 加一条`- /etc/letsencrypt:/etc/letsencrypt:ro`：letsencrypt 的证书可能用 sym link，docker 里和 host 里的路径需要完全相同，挂载的文件夹需要包含 symlink 文件和原文件
  - 可以注释掉 143 和 587 端口，这两个是允许明文收发邮件的不推荐用
- mailserver.env
  - SSL_TYPE： letsencrypt

启停 DMS 用以下命令。注意：**不要用 start/stop 或者 ctrl-c，可能导致问题**

```shell
docker-compose up
docker-compose up -d
docker-compose down
```

启动 docker mailserver

```shell
docker-compose up
```

以下命令都假设在`docker-compose.yml`中`container_name`没改（默认是`mailserver`）。

首次启动时 dovecot 需要至少一个账户才能启动。首次启动之后开另一个命令行添加账户

```shell
docker exec -it mailserver setup email add me@example.com
```

别名 postmaster 账户

```shell
docker exec -it mailserver setup alias add postmaster@example.com me@example.com
```

要让其他邮件服务器可以找到负责 example.com 的邮件服务器，需要在 dns 里添加 mx（mail exchange） 记录。按照上面的配置，mx 记录的值应该是 mail.example.com。下面是一个例子

![image](https://user-images.githubusercontent.com/29757093/224523875-bce3efc3-83c0-4589-81dd-b72297cb3202.png)

到这里就应该可以正常收邮件和发站内信了。DMS 不提供 web 界面，可以用 k9 mail app，nextcloud 的 mail 插件等查看邮件。配置过程中收邮件的协议应该是 imap，端口 993；发邮件的协议应该是 smtp，端口 465。这两个端口都是强制加密的，客户端和**自己的**邮件服务器之间的通信不会有明文邮件内容。

## 收多个域名的邮件

比如邮件服务器在 mail.example.com 上，想要收 me@another.com 邮箱的邮件。如果你能修改 another.com 的 mx 记录，这个非常简单。

首先在 DMS 里创建一个用户 me@another.com

```shell
docker exec -it mailserver setup email add me@another.com
```

之后给 another.com 添加 mx 记录。你会发现 mx 记录除了一个网址之外还有一个数，这代表这条 mx 记录的优先级，数越小优先级越高，一般是 10 的倍数。其他人在给 another.com 发邮件时会按 mx 记录优先级从高到低（那个数字从小到大）一个一个尝试，成功投递就不往后试了。你可以给自己的服务器一个高优先级，之后给一个第三方可靠的方案，比如 zoho（用自己的域名免费）或者 proton mail（用自己的域名应该收费）一个低的优先级作为备份。一个例子

![image](https://user-images.githubusercontent.com/29757093/224524919-167eb029-91c8-40ba-88b2-7ce035e8de5f.png)

## 发送

dkim

```shell
docker exec -ti mailserver setup config dkim
```

[上述参考](https://docker-mailserver.github.io/docker-mailserver/edge/usage/)

https://app.sendinblue.com/
